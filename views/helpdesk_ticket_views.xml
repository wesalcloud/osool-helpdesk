<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extended Ticket Form View -->
    <record id="helpdesk_ticket_view_form_inherit" model="ir.ui.view">
        <field name="name">helpdesk.ticket.form.inherit</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_ticket_view_form"/>
        <field name="arch" type="xml">
            
            <!-- Add statusbar buttons for Assigned stage -->
            <xpath expr="//header" position="inside">
                <button name="action_start_work" 
                        string="Start Work" 
                        type="object" 
                        class="oe_highlight" 
                        invisible="1"/>
                <button name="action_request_info" 
                        string="Request Info" 
                        type="object" 
                        invisible="1"/>
                <button name="action_send_team_department_notification" 
                        string="Notify Department" 
                        type="object" 
                        class="btn-primary"
                        invisible="not team_department_id or department_notified"
                        confirm="Are you sure you want to send email notification to this department?"/>
            </xpath>
            
            <!-- Show notification success message -->
            <xpath expr="//header" position="after">
                <div class="alert alert-success text-center" role="alert" invisible="not department_notified">
                    <strong>Department Notification Sent Successfully!</strong>
                </div>
            </xpath>
            
            <!-- Hide stage selection widget -->
            <xpath expr="//field[@name='stage_id']" position="attributes">
                <attribute name="widget">statusbar</attribute>
                <attribute name="options">{'clickable': '0'}</attribute>
            </xpath>
            
            <!-- Add CSS class to form -->
            <xpath expr="//form" position="attributes">
                <attribute name="class">o_helpdesk_ticket_form</attribute>
            </xpath>
            
            <!-- Make form readonly for agents if not their ticket -->
            <xpath expr="//sheet" position="attributes">
                <attribute name="readonly">not can_edit_ticket</attribute>
            </xpath>
            
            <!-- Override name field to make it single line -->
            <field name="name" position="attributes">
                <attribute name="widget">char</attribute>
                <attribute name="placeholder">Ticket Subject / Title</attribute>
            </field>
            
            <!-- Description field - readonly when email or not ticket owner (except for supervisors/managers) -->
            <field name="description" position="attributes">
                <attribute name="readonly">caller_source == 'email' or (user_id and user_id != uid and not can_edit_ticket)</attribute>
            </field>
            
            <!-- Hide Helpdesk Team -->
            <field name="team_id" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            
            <!-- Change label to 'Ticket Owner' and make it readonly -->
            <field name="user_id" position="attributes">
                <attribute name="string">Ticket Owner</attribute>
            </field>
            
            <!-- Add hidden fields and department after user_id -->
            <field name="user_id" position="after">
                <!-- Hidden fields for stage conditions -->
                <field name="is_stage_new" invisible="1"/>
                <field name="is_stage_assigned" invisible="1"/>
                <field name="is_stage_in_progress" invisible="1"/>
                <field name="ticket_owner_id" invisible="1"/>
                <field name="reject_by" invisible="1"/>
                <field name="conversation_id" invisible="1"/>
                <field name="department_notified" invisible="1"/>
                <field name="can_edit_ticket" invisible="1"/>
                
                <!-- Site and Department -->
                <field name="site_id"/>
                <field name="team_department_id" domain="[('site_id', '=', site_id)]" readonly="is_stage_assigned"/>
                <!-- Department Assignment - editable in New or In Progress -->
                <field name="conversation_type" readonly="1" invisible="1"/>
                <label for="conversation_type" string="Conversation Detail" invisible="1"/>
                <div class="o_row" invisible="1">
                    <button name="action_open_genesys_conversation" 
                            type="object" 
                            string="View Conversation Detail" 
                            icon="fa-external-link"
                            class="btn-link"/>
                </div>
                <field name="queue_name" readonly="1"/>
                <field name="agent_email" readonly="1" invisible="1"/>
                <field name="agent_name" readonly="1" invisible="1"/>
                <label for="created_via" string="Created Via"/>
               <div class="o_row">
                    <field name="created_via" readonly="1" nolabel="1" invisible="created_via and 'Genesys' in created_via"/>
                    <button name="action_open_genesys_conversation"
                            type="object"
                            class="oe_link p-0"
                            invisible="not created_via or 'Genesys' not in created_via"
                            style="display: inline-flex; align-items: center;">
                            <span class="d-flex"><field name="created_via" readonly="1" nolabel="1" force_save="1"/>
                            <i class="fa fa-external-link ms-1"/>
                            </span> 
                    </button>
                </div>
            </field>

            <!-- Hide standard partner_phone field and its label -->
            <xpath expr="//label[@for='partner_phone']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <field name="partner_phone" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            
            <!-- Hide email_cc field to reposition it -->
            <field name="email_cc" position="replace"/>
            
            <!-- Partner field -->
            <field name="partner_id" position="attributes">
                <attribute name="string">Customer Name</attribute>
            </field>
            
            <!-- Priority field -->
            <field name="priority" position="attributes">
                <attribute name="readonly">1</attribute>
            </field>
            
            <!-- Tag field -->
            <field name="tag_ids" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            
            <!-- Move Category, Subcategory, Form Type after Priority -->
            <field name="priority" position="after">
                <field name="request_category_id" options="{'no_create': True}" required="1"/>
                <field name="request_subcategory_id" 
                       domain="[('category_id', '=', request_category_id)]"
                       options="{'no_create': True}"/>
                <field name="form_type" readonly="1"/>
            </field>
            
            <!-- Reorder fields after partner_id -->
            <field name="partner_id" position="after">
                <field name="partner_phone" widget="phone"/>
                <field name="partner_email"/>
                <field name="ticket_phone" widget="phone"/>
                <field name="ticket_email" widget="email" invisible="1"/>
                <field name="interaction_mode" invisible="1"/>
                <field name="caller_source"/>
                <field name="ticket_building"/>
                <field name="ticket_floor"/>
            </field>
            
            <!-- Hide description tab/page when channel is email -->
            <xpath expr="//page[field[@name='description']]" position="attributes">
                <attribute name="invisible">caller_source == 'email'</attribute>
            </xpath>
            
            <!-- Hide Extra Info tab from base helpdesk module -->
            <xpath expr="//page[@name='extra_info']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            
            <!-- Add CSS to hide phone/SMS links and state selection -->
            <xpath expr="//form" position="inside">
                <style>
                    .o_helpdesk_ticket_form .o_field_phone_sms,
                    .o_helpdesk_ticket_form .o_phone_form_link {
                        display: none !important;
                    }
                    .o_helpdesk_ticket_form .o_field_state_selection {
                        display: none !important;
                    }
                </style>
            </xpath>
            
            <!-- Add custom fields in a new notebook page -->
            <xpath expr="//notebook" position="inside">
                
                <!-- Email Content Tab (visible only when channel is email) -->
                <page string="Email" invisible="caller_source != 'email'">
                    <group>
                        <field name="email_content" nolabel="1" readonly="1" options="{'collaborative': false, 'resizable': true, 'codeview': false}"/>
                    </group>
                </page>
                
                <!-- Complaint Fields -->
                <page string="Complaint Details" invisible="form_type != 'complaint'">
                    <group>
                        <group string="Complaint Information">
                            <field name="complaint_type"/>
                            <field name="complaint_severity"/>
                        </group>
                    </group>
                </page>
                
                <!-- Marketing Fields -->
                <page string="Marketing Details" invisible="form_type != 'marketing'">
                    <group>
                        <group string="Campaign Information">
                            <field name="marketing_campaign"/>
                            <field name="marketing_budget" widget="monetary"/>
                        </group>
                        <group string="Campaign Timeline">
                            <field name="marketing_start_date"/>
                            <field name="marketing_end_date"/>
                        </group>
                    </group>
                </page>
                
                <!-- Security Fields -->
                <page string="Security Details" invisible="form_type != 'security'">
                    <group>
                        <group string="Incident Information">
                            <field name="security_incident_type"/>
                            <field name="security_location"/>
                            <field name="security_witness"/>
                        </group>
                    </group>
                </page>
                
                <!-- Lift Booking Fields -->
                <page string="Lift Booking Details" invisible="form_type not in ['vvip_lift', 'regular_lift']">
                    <group>
                        <group string="Booking Information">
                            <field name="lift_booking_date" widget="datetime"/>
                            <field name="lift_size"/>
                        </group>
                        <group string="Location Details">
                            <field name="lift_floor_from"/>
                            <field name="lift_floor_to"/>
                        </group>
                    </group>
                    <group string="Items Description">
                        <field name="lift_items_description" nolabel="1"/>
                    </group>
                </page>
                
                <!-- Procurement Fields -->
                <page string="Procurement Details" invisible="form_type != 'procurement'">
                    <group>
                        <group string="Item Information">
                            <field name="procurement_item"/>
                            <field name="procurement_quantity"/>
                            <field name="procurement_vendor"/>
                        </group>
                        <group string="Budget &amp; Timeline">
                            <field name="procurement_budget" widget="monetary"/>
                            <field name="procurement_required_date"/>
                        </group>
                    </group>
                </page>
                
                <!-- HR Fields -->
                <page string="HR Details" invisible="form_type != 'hr'">
                    <group>
                        <group string="Request Information">
                            <field name="hr_request_type"/>
                            <field name="hr_employee_id"/>
                            <field name="hr_department"/>
                        </group>
                    </group>
                </page>
                
                <!-- Announcement Fields -->
                <page string="Announcement Details" invisible="form_type != 'announcement'">
                    <group>
                        <group string="Announcement Information">
                            <field name="announcement_title"/>
                            <field name="announcement_target_audience"/>
                        </group>
                        <group string="Publication Period">
                            <field name="announcement_publish_date"/>
                            <field name="announcement_expiry_date"/>
                        </group>
                    </group>
                    <group string="Content">
                        <field name="announcement_content" nolabel="1" widget="html"/>
                    </group>
                </page>
                
                <!-- Maximo Fields -->
                <page string="Maximo Details" invisible="form_type != 'maximo'">
                    <group>
                        <group string="Work Order Information">
                            <field name="maximo_work_order"/>
                            <field name="maximo_asset_id"/>
                        </group>
                        <group string="Location &amp; Priority">
                            <field name="maximo_location"/>
                            <field name="maximo_priority"/>
                        </group>
                    </group>
                </page>
                
                <!-- SLA & Status Info -->
                <page string="SLA &amp; Status">
                    <group>
                        <group string="Status Information">
                            <field name="status" readonly="1"/>
                            <field name="date_last_stage_update" readonly="1"/>
                            <field name="days_open" readonly="1"/>
                        </group>
                        <group string="SLA Tracking">
                            <field name="sla_id" readonly="1"/>
                            <field name="response_deadline" readonly="1"/>
                            <field name="resolution_deadline" readonly="1"/>
                            <field name="sla_failed" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="Escalation Details">
                            <field name="escalated" readonly="1"/>
                            <field name="escalation_date" readonly="1"/>
                            <field name="escalated_to_id" readonly="1"/>
                        </group>
                        <group string="Customer Survey">
                            <field name="survey_id" readonly="1"/>
                            <field name="survey_sent" readonly="1"/>
                            <field name="survey_completed" readonly="1"/>
                        </group>
                    </group>
                </page>
                
                <!-- Audit Trail -->
                <page string="Audit Trail">
                    <field name="audit_log_ids" readonly="1" nolabel="1">
                        <list create="0" edit="0" delete="0">
                            <field name="timestamp" widget="datetime"/>
                            <field name="user_id"/>
                            <field name="action"/>
                            <field name="description"/>
                        </list>
                    </field>
                </page>
                
                <!-- Tenant Details Tab (visible only when partner is a tenant) -->
                <page string="Tenant Details" invisible="not is_partner_tenant">
                    <field name="is_partner_tenant" invisible="1"/>
                    <group>
                        <group string="Tenant Information">
                            <field name="partner_id" readonly="1" force_save="1"/>
                            <field name="tenant_brand_name"/>
                        </group>
                        <group string="Classification">
                            <field name="tenant_vip_status" widget="badge" decoration-danger="tenant_vip_status == 'vvip'" decoration-info="tenant_vip_status == 'vip'"/>
                            <field name="tenant_status" widget="badge"/>
                            <field name="tenant_type"/>
                            <field name="tenant_business_category"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Location Details">
                            <field name="tenant_site"/>
                            <field name="tenant_building_name"/>
                            <field name="tenant_unit_number"/>
                            <field name="tenant_floor_number"/>
                        </group>
                        
                        <group string="Contact Information">
                            <field name="tenant_phone_primary" widget="phone"/>
                            <field name="tenant_phone_secondary" widget="phone"/>
                            <field name="tenant_email_primary" widget="email"/>
                            <field name="tenant_email_secondary" widget="email"/>
                        </group>
                    </group>
                    
                    <group string="Contract Information">
                        <group>
                            <field name="tenant_contract_number"/>
                            <field name="tenant_contract_start_date"/>
                            <field name="tenant_contract_end_date"/>
                        </group>
                        <group>
                            <field name="tenant_contract_active" widget="boolean_toggle"/>
                        </group>
                    </group>
                    
                    <div class="oe_button_box">
                        <button name="action_open_tenant_profile"
                                type="object"
                                string="View Full Tenant Profile"
                                class="btn-primary"/>
                    </div>
                </page>
                
            </xpath>
            
        </field>
    </record>

    <!-- Extended Search View for Analysis -->
    <record id="helpdesk_ticket_view_search_inherit" model="ir.ui.view">
        <field name="name">helpdesk.ticket.search.inherit</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_tickets_view_search"/>
        <field name="arch" type="xml">
            <!-- Add searchable fields -->
            <xpath expr="//field[@name='stage_id']" position="after">
                <field name="team_department_id" string="Department"/>
                <field name="site_id" string="Site"/>
                <field name="request_category_id" string="Category"/>
            </xpath>
            
            <!-- Add filters -->
            <xpath expr="//filter[@name='is_close']" position="after">
                <separator/>
                <filter string="Today" name="filter_today" domain="[('create_date', '&gt;=', datetime.datetime.now().replace(hour=0, minute=0, second=0)), ('create_date', '&lt;=', datetime.datetime.now().replace(hour=23, minute=59, second=59))]"/>
                <filter string="This Week" name="filter_week" domain="[('create_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('create_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="This Month" name="filter_month" domain="[('create_date', '&gt;=', context_today().strftime('%Y-%m-01'))]"/>
                <filter string="This Year" name="filter_year" domain="[('create_date', '&gt;=', context_today().strftime('%Y-01-01'))]"/>
                <separator/>
                <filter string="Has Department" name="filter_department" domain="[('team_department_id', '!=', False)]"/>
                <filter string="Has Site" name="filter_site" domain="[('site_id', '!=', False)]"/>
                <filter string="Has Category" name="filter_category" domain="[('request_category_id', '!=', False)]"/>
            </xpath>
            
            <!-- Add group by options -->
            <xpath expr="//filter[@name='stage']" position="after">
                <filter string="Department" name="group_department" context="{'group_by': 'team_department_id'}"/>
                <filter string="Site" name="group_site" context="{'group_by': 'site_id'}"/>
                <filter string="Category" name="group_category" context="{'group_by': 'request_category_id'}"/>
                <separator/>
                <filter string="Creation Date" name="group_create_date" context="{'group_by': 'create_date:day'}"/>
                <filter string="Close Date" name="group_close_date" context="{'group_by': 'close_date:day'}"/>
            </xpath>
        </field>
    </record>

    <!-- Extended Ticket List View -->
    <record id="helpdesk_ticket_view_list_inherit" model="ir.ui.view">
        <field name="name">helpdesk.ticket.list.inherit</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_tickets_view_tree"/>
        <field name="arch" type="xml">
            <!-- Set default order to newest first -->
            <xpath expr="//list" position="attributes">
                <attribute name="default_order">create_date desc</attribute>
            </xpath>
            
            <!-- Change column labels -->
            <xpath expr="//field[@name='create_date']" position="attributes">
                <attribute name="string">Date</attribute>
            </xpath>
            
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="string">Subject</attribute>
            </xpath>
            
            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="string">Ticket Owner</attribute>
            </xpath>
            
            <!-- Make Priority readonly in list view -->
            <xpath expr="//field[@name='priority']" position="attributes">
                <attribute name="readonly">1</attribute>
            </xpath>
            
            <!-- Hide status change button in list view -->
            <xpath expr="//field[@name='stage_id']" position="attributes">
                <attribute name="widget">badge</attribute>
                <attribute name="readonly">1</attribute>
            </xpath>
            
            <!-- Hide kanban state dropdown button in list view -->
            <xpath expr="//field[@name='kanban_state']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            
            <!-- Add new fields and reorder -->
            <xpath expr="//field[@name='priority']" position="after">
                <field name="site_id" optional="show"/>
            </xpath>
            
            <xpath expr="//field[@name='partner_id']" position="replace"/>
            
            <xpath expr="//field[@name='site_id']" position="after">
                <field name="partner_id" string="Customer Name" optional="show"/>
            </xpath>
            
            <xpath expr="//field[@name='name']" position="after">
                <field name="request_category_id" string="Category" optional="show"/>
                <field name="caller_source" string="Channel" optional="show"/>
                <field name="status" optional="hide"/>
            </xpath>
            
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="team_department_id" string="Assigned To" optional="show"/>
            </xpath>
            
            <xpath expr="//field[@name='activity_ids']" position="attributes">
                <attribute name="optional">hide</attribute>
            </xpath>
            
            <xpath expr="//field[@name='sla_deadline']" position="attributes">
                <attribute name="optional">hide</attribute>
            </xpath>
        </field>
    </record>

</odoo>
