<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Security Groups -->
    <record id="group_helpdesk_cx_agent" model="res.groups">
        <field name="name">CX Agent</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
        <field name="comment">Can create and view tickets, send acknowledgments</field>
    </record>

    <record id="group_helpdesk_team_member" model="res.groups">
        <field name="name">Helpdesk Team Member</field>
        <field name="implied_ids" eval="[(4, ref('helpdesk.group_helpdesk_user'))]"/>
        <field name="comment">Can handle assigned tickets</field>
    </record>

    <record id="group_helpdesk_team_leader" model="res.groups">
        <field name="name">Helpdesk Team Leader</field>
        <field name="implied_ids" eval="[(4, ref('group_helpdesk_team_member'))]"/>
        <field name="comment">Can manage team tickets and escalations</field>
    </record>

    <record id="group_helpdesk_manager" model="res.groups">
        <field name="name">Helpdesk Manager</field>
        <field name="implied_ids" eval="[(4, ref('helpdesk.group_helpdesk_manager')), (4, ref('group_helpdesk_team_leader'))]"/>
        <field name="comment">Full access to helpdesk configuration</field>
    </record>

    <!-- Extra Rights Groups -->
    <record id="group_delete_tickets" model="res.groups">
        <field name="name">Delete Tickets</field>
        <field name="comment">Extra right: Can delete helpdesk tickets</field>
    </record>

    <record id="group_delete_contacts" model="res.groups">
        <field name="name">Delete Contacts</field>
        <field name="comment">Extra right: Can delete contacts/partners</field>
    </record>

    <!-- Record Rules -->
    
    <!-- CX Agent: Can see all tickets they created -->
    <record id="helpdesk_ticket_rule_cx_agent" model="ir.rule">
        <field name="name">CX Agent: Own Tickets</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">[('create_uid', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_helpdesk_cx_agent'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Team Member: Can see tickets assigned to them or their team -->
    <record id="helpdesk_ticket_rule_team_member" model="ir.rule">
        <field name="name">Team Member: Assigned Tickets</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">['|', ('user_id', '=', user.id), ('team_id.member_ids', 'in', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_helpdesk_team_member'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Team Leader: Can see all tickets in their teams (NO DELETE unless has extra right) -->
    <record id="helpdesk_ticket_rule_team_leader" model="ir.rule">
        <field name="name">Team Leader: Team Tickets</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">[('team_id.member_ids', 'in', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_helpdesk_team_leader'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Manager: Full Access (NO DELETE unless has extra right) -->
    <record id="helpdesk_ticket_rule_manager" model="ir.rule">
        <field name="name">Manager: All Tickets</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_helpdesk_manager'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Delete Tickets Extra Right: Can delete tickets -->
    <record id="helpdesk_ticket_rule_delete" model="ir.rule">
        <field name="name">Delete Tickets: Extra Right</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_delete_tickets'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="1"/>
    </record>

    <!-- Portal Users: Own Tickets Only -->
    <record id="helpdesk_ticket_rule_portal" model="ir.rule">
        <field name="name">Portal User: Own Tickets</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="domain_force">[('partner_id', '=', user.partner_id.id)]</field>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="0"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Category & Subcategory Access -->
    <record id="helpdesk_category_rule_all" model="ir.rule">
        <field name="name">Category: All Users</field>
        <field name="model_id" ref="model_helpdesk_category"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_user')), (4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="0"/>
        <field name="perm_create" eval="0"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <record id="helpdesk_subcategory_rule_all" model="ir.rule">
        <field name="name">Subcategory: All Users</field>
        <field name="model_id" ref="model_helpdesk_subcategory"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_user')), (4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="0"/>
        <field name="perm_create" eval="0"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Audit Log: Read-only for all, write for system -->
    <record id="helpdesk_audit_rule_read" model="ir.rule">
        <field name="name">Audit: Read Access</field>
        <field name="model_id" ref="model_helpdesk_audit"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_helpdesk_team_member'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="0"/>
        <field name="perm_create" eval="0"/>
        <field name="perm_unlink" eval="0"/>
    </record>

    <!-- Delete Contacts Extra Right: Can delete partners/contacts -->
    <record id="partner_delete_rule" model="ir.rule">
        <field name="name">Delete Contacts: Extra Right</field>
        <field name="model_id" ref="base.model_res_partner"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_delete_contacts'))]"/>
        <field name="perm_read" eval="1"/>
        <field name="perm_write" eval="1"/>
        <field name="perm_create" eval="1"/>
        <field name="perm_unlink" eval="1"/>
    </record>

</odoo>
